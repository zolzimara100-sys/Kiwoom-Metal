import pandas as pd
import os

# Define the input and output paths
input_file = 'crawler-kospi200/kospi200_list.csv'
output_file = 'classified_stock_list.csv'

# Ensure the input file exists
if not os.path.exists(input_file):
    print(f"Error: {input_file} not found.")
    exit(1)

# Read the CSV file
df = pd.read_csv(input_file, dtype={'code': str})

# Initialize the 'categories' column
df['categories'] = ""

# Define keywords for simpler matching
keywords = {
    "반도체": ["반도체", "하이닉스", "DB하이텍", "한미반도체", "주성엔지니어링"],
    "조선": ["중공업", "조선", "오션", "미포"], 
    "화학": ["화학", "케미칼", "금호석유", "효성티앤씨", "효성첨단소재", "코오롱인더"],
    "자동차": ["자동차", "현대차", "기아", "모비스", "만도", "타이어", "한온시스템", "현대위아"],
    "철강": ["제철", "동국제강", "세아베스틸", "KG스틸", "고려아연", "풍산", "POSCO"],
    "통신": ["양방향", "통신", "텔레콤", "유플러스", "KT"],
    "에너지": ["한국전력", "가스공사", "에너빌리티", "난방공사", "한전", "에너지", "씨에스윈드"], 
    "바이오/제약/의학": ["바이오", "약품", "제약", "생명과학", "종근당", "셀트리온", "부광약품", "대웅", "녹십자", "한올바이오", "유한양행", "에스디바이오센서"],
    "증권사": ["증권", "투자"],
    "은행": ["은행", "금융", "지주"], 
    "방산": ["에어로스페이스", "넥스원", "항공우주", "현대로템", "화학", "풍산", "한화시스템"],
    "2차전지": ["에너지솔루션", "SDI", "이노베이션", "퓨처엠", "에코프로", "엘앤에프", "금양", "코스모신소재"],
    
    # New Categories
    "AI/인공지능": ["NAVER", "카카오", "삼성에스디에스", "SK C&C"], 
    "게임": ["크래프톤", "넷마블", "엔씨소프트", "더블유게임즈", "펄어비스", "카카오게임즈"],
    "손해보험": ["화재", "손해보험", "해상", "DB손보"],
    "생명보험": ["생명"], 
    "엔터테인": ["하이브", "에스엠", "와이지", "JYP", "스튜디오드래곤", "CJ ENM", "콘텐트리"],
    "화장품/뷰티": ["아모레", "생활건강", "코스맥스", "한국콜마", "애경산업", "에이피알"],
    "자원개발/상사": ["인터내셔널", "물산", "LX인터내셔널", "포스코인터내셔널"],
    "건설": ["건설", "이앤씨", "산업개발", "삼성E&A", "한샘", "KCC", "한일시멘트", "아세아시멘트"],
    "해운/물류/항공": ["해운", "항공", "글로비스", "대한통운", "팬오션", "HMM", "진에어", "티웨이", "한진칼"],
    "식음료": ["제일제당", "오리온", "농심", "삼양식품", "하이트진로", "롯데칠성", "오뚜기", "동서", "동원산업", "롯데웰푸드", "대상"],
    "유통/백화점": ["롯데쇼핑", "신세계", "현대백화점", "이마트", "BGF리테일", "GS리테일", "호텔신라", "면세점"],
    "지주사": ["지주", "홀딩스", "SK", "LS", "LG", "두산", "한화", "CJ", "HDC", "DL", "F&F홀딩스", "영원무역홀딩스"],
    "IT부품/장비": ["삼성전기", "LG이노텍", "LG디스플레이", "두산로보틱스", "에스엘", "한화비전", "현대오토에버"],
    "기계/장비": ["두산밥캣", "현대인프라코어", "현대엘리베이터", "한화에어로스페이스", "현대로템", "DN오토모티브", "티와이홀딩스"],
    "섬유/의복": ["F&F", "영원무역", "한섬", "휠라홀딩스"],
    "여행/레저": ["강원랜드", "파라다이스", "하나투어", "GKL"],
}

# Explicit mapping for accuracy
explicit_mapping = {
    # 반도체
    "005930": ["반도체", "AI/인공지능"], 
    "000660": ["반도체", "AI/인공지능"], 
    "042700": ["반도체"], 
    "000990": ["반도체"], 
    "007660": ["반도체", "AI/인공지능"], 
    "402340": ["반도체"], 
    
    # IT/플랫폼/AI
    "035420": ["AI/인공지능"], 
    "035720": ["AI/인공지능"], 
    "018260": ["AI/인공지능"], 
    "011070": ["IT부품/장비"], 
    "034220": ["IT부품/장비"], 
    "009150": ["IT부품/장비"], 
    "454910": ["기계/장비", "AI/인공지능"], 
    "021240": ["생활가전"], 
    
    # 게임
    "259960": ["게임"], 
    "251270": ["게임"], 
    "036570": ["게임"], 
    
    # 엔터테인
    "352820": ["엔터테인"], 
    "030000": ["엔터테인"], 
    
    # 화장품/뷰티
    "090430": ["화장품/뷰티"], 
    "051900": ["화장품/뷰티"], 
    "192820": ["화장품/뷰티"], 
    "161890": ["화장품/뷰티"], 
    "278470": ["화장품/뷰티"], 
    
    # 보험
    "000810": ["손해보험"], 
    "005830": ["손해보험"], 
    "001450": ["손해보험"], 
    "000400": ["손해보험"], 
    "000370": ["손해보험"], 
    "032830": ["생명보험", "손해보험"], 
    "088350": ["생명보험", "손해보험"], 
    
    # 금융
    "029780": ["은행"], 
    
    # 자원/상사/건설
    "047050": ["자원개발/상사", "에너지"], 
    "001120": ["자원개발/상사"], 
    "028260": ["자원개발/상사", "건설", "바이오/제약/의학"], 
    "000720": ["건설"], 
    "006360": ["건설"], 
    "047040": ["건설"], 
    "375500": ["건설"], 
    "294870": ["건설"], 
    "002990": ["건설"], 
    "028050": ["건설", "에너지"], 
    "002380": ["건설"], 
    "009240": ["건설"], 
    "300720": ["건설"], 
    "017800": ["기계/장비"], 
    
    # 물류/항공
    "011200": ["해운/물류/항공"], 
    "086280": ["해운/물류/항공"], 
    "003490": ["해운/물류/항공", "방산"], 
    "028670": ["해운/물류/항공"], 
    "000120": ["해운/물류/항공"], 
    "020560": ["해운/물류/항공"], 
    "272450": ["해운/물류/항공"], 
    "180640": ["해운/물류/항공", "지주사"], 
    
    # 식음료
    "097950": ["식음료"], 
    "271560": ["식음료"], 
    "004370": ["식음료"], 
    "003230": ["식음료"], 
    "000080": ["식음료"], 
    "280360": ["식음료"], 
    "006040": ["식음료"], 
    "001680": ["식음료"], 
    
    # 유통
    "023530": ["유통/백화점"], 
    "004170": ["유통/백화점"], 
    "069960": ["유통/백화점"], 
    "139480": ["유통/백화점"], 
    "007070": ["유통/백화점"], 
    "282330": ["유통/백화점"], 
    "008770": ["유통/백화점", "여행/레저"], 
    
    # 섬유
    "383220": ["섬유/의복"], 
    "111770": ["섬유/의복"], 
    "009970": ["지주사"], 
    "020000": ["섬유/의복"], 

    # 레저
    "035250": ["여행/레저"], 
    "114090": ["여행/레저"], 
    "039130": ["여행/레저"], 
    
    # 지주사
    "034730": ["지주사"], 
    "003550": ["지주사", "2차전지"], 
    "000150": ["지주사", "에너지"], 
    "000880": ["방산", "화학", "지주사"], 
    "001040": ["지주사", "식음료"], 
    "006260": ["지주사", "에너지"], 
    "012630": ["지주사", "건설"], 
    "000210": ["지주사", "화학"], 
    "267250": ["지주사", "조선"], 
    
    # 기계/장비
    "443060": ["기계/장비"], 
    "241560": ["기계/장비"], 
    "042670": ["기계/장비"], 
    "267260": ["에너지"], 
    "010120": ["에너지"], 
    
    # 기타/자동차
    "012750": ["기타"], 
    "489790": ["IT부품/장비"], 
    "005850": ["자동차"], 
    "007340": ["자동차"], 
    "000240": ["지주사", "자동차"], 
    "081660": ["지주사"], 
    
    # 화학/에너지/2차전지
    "011170": ["화학"], 
    "011780": ["화학"], 
    "009830": ["화학", "2차전지", "에너지"], 
    "010950": ["화학", "에너지"], 
    "078930": ["에너지", "자원개발/상사"], 
    "011790": ["화학", "2차전지"], 
    "093370": ["화학", "2차전지"], 
    "069260": ["화학"], 
    "066570": ["IT부품/장비", "자동차"], 
    "456040": ["화학", "에너지"], 
    
    # 바이오 etc
    "207940": ["바이오/제약/의학"], 
    "068270": ["바이오/제약/의학"], 
    "326030": ["바이오/제약/의학"], 
    "000100": ["바이오/제약/의학"],
    "128940": ["바이오/제약/의학"], 
    "069620": ["바이오/제약/의학"], 
    "185750": ["바이오/제약/의학"], 
    "006280": ["바이오/제약/의학"], 
    "009420": ["바이오/제약/의학"], 
    "302440": ["바이오/제약/의학"], 
    "137310": ["바이오/제약/의학"],
    "0126Z0": ["바이오/제약/의학"],
    "000105": ["바이오/제약/의학"],
    
    # 증권사
    "138040": ["증권사", "손해보험"], 
    "006800": ["증권사"], 
    "005940": ["증권사"], 
    "016360": ["증권사"], 
    "039490": ["증권사"], 
    "071050": ["증권사"], 
    
    # Remainings
    "022100": ["IT부품/장비", "AI/인공지능", "철강"],
    "008930": ["지주사", "바이오/제약/의학"],
    "000670": ["철강", "자원개발/상사"],
    "006650": ["화학"],
    "002710": ["철강", "2차전지"],
    "002840": ["화학"],
    "145720": ["바이오/제약/의학"],
    "002710": ["철강", "2차전지"],
    "022100": ["IT부품/장비", "AI/인공지능", "철강"],
    "002840": ["화학"],
    "017960": ["조선", "화학"],
    "014820": ["화학", "2차전지"],
    "004490": ["2차전지", "자동차"],
    "003240": ["화학", "섬유/의복"], # Fixed typo
    "268280": ["화학"],
    "003620": ["자동차"],
    "000050": ["섬유/의복", "유통/백화점"],
    "010060": ["화학", "에너지"],
    "457190": ["화학", "2차전지"],
}


classified_rows = []

for index, row in df.iterrows():
    code = str(row['code']).zfill(6)
    name = row['name']
    tags = set()
    
    if code in explicit_mapping:
        tags.update(explicit_mapping[code])
    else:
        for category, key_list in keywords.items():
            for key in key_list:
                if key in name:
                     if category == "화학" and ("한화" in name or "기계" in name) and "솔루션" not in name and "케미칼" not in name:
                         continue
                     if category == "통신" and "이수" in name:
                         continue
                     tags.add(category)

    if not tags:
        if "스팩" in name: tags.add("기타")
    
    # Save
    row['categories'] = ",".join(list(tags))
    classified_rows.append(row)

result_df = pd.DataFrame(classified_rows)
result_df.to_csv(output_file, index=False, encoding='utf-8-sig')

print(f"Classification complete. Saved to {output_file}")
