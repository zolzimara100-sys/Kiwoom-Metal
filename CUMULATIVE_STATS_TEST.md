# 누적 통계 로직 테스트 가이드

## ✅ 구현 완료

### 📍 위치
- 파일: `/frontend/pages/DataCollection.tsx`
- 함수: `handleKospi200Submit()`
- 라인: 619-626

### 🎯 핵심 로직
```javascript
setKospi200TotalStats(prev => ({
  totalReceived: prev.totalReceived + progress.receivedCount,
  totalSaved: prev.totalSaved + progress.savedCount,
  totalDuplicate: prev.totalDuplicate + progress.duplicateCount,
  totalError: progress.errors.length,
}));
```

## 📊 작동 원리

### 요구사항
- **누적 수신** = sum(모든 종목들의 '현재 종목 수신' 값)
- **누적 저장** = sum(모든 종목들의 '현재 종목 저장' 값)
- **누적 중복** = sum(모든 종목들의 '현재 종목 중복' 값)
- **종목 변경과 무관**하게 계속 누적

### 실제 작동 예시

```
시작: 누적 수신 = 0

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[종목A: 삼성전자]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Progress 1:
  현재 종목 수신: 10
  → 누적 수신 = 0 + 10 = 10 ✅

Progress 2:
  현재 종목 수신: 20
  → 누적 수신 = 10 + 20 = 30 ✅

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[종목B: SK하이닉스] ← 종목 변경
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Progress 3:
  현재 종목 수신: 5
  → 누적 수신 = 30 + 5 = 35 ✅

Progress 4:
  현재 종목 수신: 15
  → 누적 수신 = 35 + 15 = 50 ✅

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[종목C: NAVER] ← 종목 변경
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Progress 5:
  현재 종목 수신: 8
  → 누적 수신 = 50 + 8 = 58 ✅
```

## 🧪 테스트 방법

### 1. 프론트엔드 실행
```bash
cd /Users/juhyunhwang/kiwoom/frontend
npm run dev
```

### 2. 백엔드 실행
```bash
cd /Users/juhyunhwang/kiwoom
./gradlew bootRun
```

### 3. 브라우저 테스트
1. `http://localhost:3000` 접속 (또는 표시된 포트)
2. "서버접속" 버튼 클릭하여 인증
3. `/data-collection` 페이지로 이동
4. "KOSPI200 선택" 라디오 버튼 선택
5. "KOSPI200 전체 수집 시작" 버튼 클릭

### 4. 확인 사항
- ✅ **현재 종목 수신**: 종목 변경 시 0으로 리셋됨 (백엔드에서 새 종목 시작)
- ✅ **누적 수신**: 종목 변경과 무관하게 계속 증가
- ✅ **누적 저장**: 종목 변경과 무관하게 계속 증가
- ✅ **누적 중복**: 종목 변경과 무관하게 계속 증가

## 📸 화면 예시

```
┌─────────────────────────────────────────┐
│ 진행상황                                 │
├─────────────────────────────────────────┤
│ 현재 처리 중인 종목                      │
│ 삼성전자 (005930)                        │
├─────────────────────────────────────────┤
│ 진행 상황: 5 / 200 (2.5% 완료)          │
├─────────────────────────────────────────┤
│ ┌───────┬───────┬───────┬───────┐      │
│ │ 수신  │ 저장  │ 중복  │ 오류  │      │
│ │  20   │  15   │   5   │   0   │ ← 현재 종목│
│ └───────┴───────┴───────┴───────┘      │
├─────────────────────────────────────────┤
│ ┌───────┬───────┬───────┬───────┐      │
│ │ 수신  │ 저장  │ 중복  │ 오류  │      │
│ │ 150   │ 120   │  30   │   0   │ ← 누적 통계│
│ └───────┴───────┴───────┴───────┘      │
└─────────────────────────────────────────┘
```

## 🔧 주요 특징

### React State 업데이트 패턴
```javascript
// ✅ 올바른 방법: prev 사용
setKospi200TotalStats(prev => ({
  totalReceived: prev.totalReceived + progress.receivedCount,
  ...
}));

// ❌ 잘못된 방법: 직접 참조 (비동기 이슈)
setKospi200TotalStats({
  totalReceived: kospi200TotalStats.totalReceived + progress.receivedCount,
  ...
});
```

### 장점
1. **단순성**: 복잡한 종목 변경 감지 로직 불필요
2. **정확성**: React의 함수형 업데이트로 항상 최신 상태 보장
3. **유지보수**: 코드가 짧고 명확하여 이해하기 쉬움

## 🐛 문제 해결

### 만약 누적이 리셋된다면?
- **원인**: 백엔드에서 `progress.receivedCount`가 누적값이 아닌 증분값을 보내고 있을 수 있음
- **해결**: 백엔드 로직 확인 필요

### 콘솔에서 확인
브라우저 개발자 도구(F12) → Console 탭에서 확인:
```javascript
// 수동으로 상태 확인
console.log('누적 통계:', kospi200TotalStats);
```

## 📝 참고사항

- 이 로직은 **프론트엔드에서만** 누적 계산
- 백엔드(`Kospi200ProgressDto`)에서 보내는 값은 **현재 종목의 통계**
- 프론트엔드에서 **모든 종목의 합계**를 계산하여 표시

## ✨ 완료 상태
- [x] 누적 수신 로직 구현
- [x] 누적 저장 로직 구현
- [x] 누적 중복 로직 구현
- [x] TypeScript 빌드 성공
- [x] 종목 변경 무관 동작 보장
