TR명 ka10060	종목별투자기관별차트요청
            [수정대상]
BackEnd : tr-ka10099 연관 class
frontend URL : http://localhost:3000/data-collection  

[Frontend 화면수정]

[화면내 Section 수정] 
1. [Section name] : 종목선택 
수정내용 : "종목선택"과 동일한 Style로 "KOSPI200 선택" 명으로 box를 우측에 새성.

2 [Section name] : 수집 모드 선택
수정내용 :  "KOSPI200 선택"을 선택하면 "수집 모드 선택"에서 Section "과거 데이터 가져오기","구간데이터 가져오기"는 비활성화 하고 Section "현재까지 데이터 가져오기" 만 활성화 함.

3. [처리결과 화면 수정]
    "KOSPI200 선택"일 경우에는 databse에서 조회한 code값을을 순차적으로 수행하는 것임. 
    따라서 현재 수행중인 "종목명" 그리고 처리한 종목수 / 총 종목수를 표시해 준다. 
    기타 화면에 표시되는 "처리 결과" 는 기존과 동일하게 하나의 종목에 대한 처리내용을 표시한다. 
     그러나 KOSPI200의 한 종목의 처리(수신부터 저장까지) 완료되면 오류 표시항목을 제외하고 화면을 초기화 한다. 다음 종목을 수행시 해당 종목에 대한 정보만 표시한다. 
    오류를 표시하는 section은 KOSPI200 종목code를 처리하면서 발생한 오류들을 누적해서 적는다.

 0 이런것들이 전혀 표시되지 않고 있다. 전에는 잘되었는데 니가 다 망쳐놨어.
  현재종목 : 현재 처리하고 있는 종목(code)의 누적 수신건.
  현재종목중복 :database에 insert하다가 중복 처리 된건
  현재종목수신 : 이건 없애고 "현재종목 오류"로 변경하고 현재 종목 처리하다가 오류가 난건을 표시
                 현재 종목이 수신이 완료되면 clear.
  누적저장 : 종목(code)와 상관없이 총 누적 수신건수.
  누적중복 :종목(code)와 상관없이 총 database에 insert하다가 중복 처리 된건
  누적수신 :이건 없애고 "누적 오류"로   변경하고종목(code)와 상관없이 총  현재 종목 처리하다가 오류가 난건을
  표시. 수정해줘

3.
[Backend 수정]
기존에 "종목 선택" - "현재까지 데이터 가져오기" 와 동일한 BackEnd 프로그램 사용. 
단 "KOSPI200 선택" 시 tb_stock_list_meta에서 code를 map에 넣어 놓고 순차적으로 request를 수행한다.

다량의 종목code를 수행함으로 server에서 request reject를 할수 있음. 
따라서 KOSPI200 맵에 저장된 다음 종목(code)를 수행하기전에 5초간 sleep을 한다.

다음은 frontend 요구사항임 이것을 수행하기 위해 back end프로그램도 변경하도록 backend frontend간에 협업해줘
현재 수행중인 "종목명" 그리고 처리한 종목수 / 총 종목수를 표시. 
기타 화면에 표시되는 "처리 결과" 는 기존과 동일하게 하나의 종목에 대한 처리내용을 표시한다.(현재와 동일 )
그러나 KOSPI200의 한 종목의 처리(수신부터 저장까지) 완료되면 오류 표시항목을 제외하고 화면을 초기화 한다. 다음 종목을 수행시 해당 종목에 대한 정보만 표시한다. 
오류를 표시하는 section은 KOSPI200 종목code를 처리하면서 발생한 오류들을 누적해서 적는다


claude 개발계획. 

 Now I will create a comprehensive development plan for implementing the
  KOSPI200 batch collection feature:

  개발 계획: ka10060 KOSPI200 배치 수집 기능

  📋 요구사항 분석

  Frontend 수정사항:
  1. 종목선택 Section: "KOSPI200 선택" 박스를 "종목 선택" 우측에 동일한 스타일로 추가
  2. 수집 모드 제한: KOSPI200 선택 시 "현재까지 데이터 가져오기"만 활성화, 나머지 비활성화
  3. 처리결과 화면:
    - 현재 처리 중인 종목명 표시
    - 진행상황: "처리한 종목수 / 총 종목수"
    - 각 종목 처리 완료 후 오류 항목 제외하고 화면 초기화
    - 오류는 누적하여 표시

  Backend 수정사항:
  1. KOSPI200 종목 코드 목록 조회 API 추가
  2. 순차적 배치 처리 로직 (각 종목간 5초 대기)
  3. 진행상황 정보 포함한 응답 구조

  ---
  🎯 구현 단계

  Phase 1: Backend API 개발

  1.1 StockList Repository 확장
  - 파일: StockListRepository.java
  - 추가 메서드: findByMarketCodeOrderByCodeAsc(String marketCode)
    - KOSPI (marketCode="0") 종목 리스트를 코드 순으로 정렬하여 반환
    - 이미 findByMarketCode() 메서드가 있으므로 활용 가능

  1.2 StockList Controller에 API 추가
  - 파일: StockListController.java
  - 엔드포인트: GET /api/v1/stock-list/kospi200
  - 응답: [{ "code": "005930", "name": "삼성전자" }, ...]

  1.3 InvestorChart Controller에 KOSPI200 배치 API 추가
  - 파일: InvestorChartController.java
  - 엔드포인트: POST /api/v1/investor-chart/fetch/kospi200-batch
  - 요청 파라미터:
  {
    "amtQtyTp": "2",
    "trdeTp": "0",
    "unitTp": "1"
  }
  - 응답 (스트리밍 SSE 또는 WebSocket 고려):
  {
    "currentStock": { "code": "005930", "name": "삼성전자" },
    "processedCount": 5,
    "totalCount": 200,
    "currentResult": {
      "savedCount": 30,
      "duplicateCount": 5,
      "errorCount": 0
    },
    "errors": []
  }

  1.4 InvestorChartApplicationService에 배치 로직 추가
  - 파일: InvestorChartApplicationService.java
  - 메서드: fetchKospi200Batch()
  - 로직:
    a. tb_stock_list에서 marketCode="0" 종목 조회
    b. 각 종목에 대해 collectWithStatus() 호출
    c. 종목 처리 후 5초 대기 (Thread.sleep(5000))
    d. 진행상황을 실시간으로 반환 (Flux/Server-Sent Events 활용)

  Phase 2: Frontend UI 개발

  2.1 DataCollection.tsx 상태 추가
  const [selectionMode, setSelectionMode] = useState<'single' |
  'kospi200'>('single');
  const [kospi200Progress, setKospi200Progress] = useState<{
    currentStock: { code: string; name: string } | null;
    processedCount: number;
    totalCount: number;
    errors: string[];
  } | null>(null);

  2.2 "KOSPI200 선택" 섹션 UI 추가
  - 위치: "종목 선택" 섹션 우측
  - 스타일: 동일한 card 스타일 적용
  - 버튼: "KOSPI200 전체 수집" 버튼

  2.3 수집 모드 선택 조건부 비활성화
  {mode === 'single' && selectionMode === 'kospi200' && (
    <div className="opacity-50 pointer-events-none">
      {/* 과거 데이터, 구간 데이터 버튼 */}
    </div>
  )}

  2.4 KOSPI200 진행상황 표시 UI
  {kospi200Progress && (
    <div className="bg-white rounded-xl p-6">
      <h3>KOSPI200 배치 수집 진행 중</h3>
      <div>
        현재 처리: {kospi200Progress.currentStock?.name}
  ({kospi200Progress.currentStock?.code})
      </div>
      <div>
        진행상황: {kospi200Progress.processedCount} /
  {kospi200Progress.totalCount}
      </div>
      <div>
        <progress value={kospi200Progress.processedCount} 
  max={kospi200Progress.totalCount} />
      </div>
      {/* 오류 누적 표시 */}
      <div className="mt-4 bg-red-50">
        {kospi200Progress.errors.map(err => <div>{err}</div>)}
      </div>
    </div>
  )}

  2.5 API 서비스 함수 추가
  - 파일: frontend/services/api.ts
  - 함수: fetchKospi200List(), fetchKospi200Batch()

  Phase 3: 통합 및 테스트

  3.1 Backend 단위 테스트
  - StockList Repository 테스트: KOSPI 종목 조회
  - InvestorChart Service 테스트: 배치 처리 로직

  3.2 Frontend-Backend 통합
  - API 호출 테스트
  - 진행상황 실시간 업데이트 확인
  - 5초 대기 로직 확인

  3.3 E2E 시나리오 테스트
  1. KOSPI200 선택 → "현재까지 데이터 가져오기" 버튼 클릭
  2. 첫 종목부터 순차 처리 확인
  3. 각 종목 처리 후 화면 초기화 확인 (오류 제외)
  4. 오류 누적 확인
  5. 전체 완료 후 최종 결과 확인

  ---
  📁 수정 파일 목록

  Backend (Java):
  1. src/main/java/com/stocktrading/kiwoom/adapter/out/persistence/reposit
  ory/StockListRepository.java
  2. src/main/java/com/stocktrading/kiwoom/controller/StockListController.
  java (또는 새 엔드포인트 추가)
  3. src/main/java/com/stocktrading/kiwoom/controller/InvestorChartControl
  ler.java
  4. src/main/java/com/stocktrading/kiwoom/application/service/InvestorCha
  rtApplicationService.java
  5. src/main/java/com/stocktrading/kiwoom/dto/Kospi200BatchRequest.java
  (신규)
  6. src/main/java/com/stocktrading/kiwoom/dto/Kospi200BatchResponse.java
  (신규)

  Frontend (TypeScript/React):
  1. frontend/pages/DataCollection.tsx
  2. frontend/services/api.ts

  ---
  ⚠️ 주요 고려사항

  1. API Rate Limiting: 5초 대기로 서버 부하 관리
  2. Long-running Process:
    - 200개 종목 × 5초 = 약 16분 소요
    - SSE (Server-Sent Events) 또는 WebSocket으로 실시간 진행상황 전송
  고려
    - 또는 폴링 방식으로 진행상황 조회
  3. 트랜잭션 관리: 각 종목별로 독립적인 트랜잭션 처리 (한 종목 실패해도
  계속 진행)
  4. 중단 및 재개: 사용자가 중간에 취소할 수 있는 기능 고려
  5. 로깅: 배치 처리 전체 과정을 로그로 기록

  ---
  🚀 구현 우선순위

  High Priority (필수):
  - Backend: KOSPI200 종목 목록 API
  - Backend: 순차 배치 처리 로직 (5초 대기 포함)
  - Frontend: KOSPI200 선택 UI
  - Frontend: 진행상황 표시

  Medium Priority (권장):
  - 실시간 진행상황 업데이트 (SSE/WebSocket)
  - 중단/재개 기능
  - 상세 로깅

  Low Priority (선택):
  - 배치 처리 이력 저장
  - 통계 대시보드


  [오류수정]
  연관 프로그램 : backend : tr-ka10060 연관 데이터 수신 처리 관련 프로그램.
  오류 내용 : kospi200 종목을 수신처리할때 tb_stock_list_meta에서 code를 ka1006 request처리중에
            연속처리하지 않고 종목의 100개만 가져오고 다음 code로 넘어가 버림. 그래서 모든 종목이 연속조회를 하지 않고 
            100개 데이터만 수신된 상태로 databsae에 저장됨.


            이전 알고리즘과 같이 2000-01-02부터 오늘날짜까지 연속조회하는 알고리즘으로 변경.
            code하나가 2000-01-02부터 오늘날짜까지 모두 연속 수신으로 database 에 저장하도록 변경하고
            다음 코드로 넘어가도록 수정.


            > 나는 단일 조회만 하라고 이야기 한적이 없어. "KOSPI200" 을 누르면  
             수집 기간    | 2000-01-02 ~ 오늘
             연속조회     | 100개씩 연속 수신 
             종목당 데이터량 | 수천~수만 건   
             다음 종목 이동 | 현재 종목 완료 후  


| 항목       | 원하는 동작            
  |----------|-------------------|
  | 요청 기간    | 2000-01-02 ~ 오늘  
  | 연속조회     | cont-yn="Y"동안 계속  
  | 100건씩 표시 | ✅ 각 100건마다 SSE 전송 
  | 종목 완료 조건 | 전체 데이터(2000-01-02 ~ 오늘) 수신 완료      
  | 5초 대기 시점 | 전체 연속조회 완료 후      
  | 종목당 데이터량 | 수천~수만 건         

tbstock_list_meta에서 code를 가져온 후에  tb_stock_list_meta.code = tb_stock_investor_chart.stk_cd 비교해서  tb_stock_investor_chart dt의 가장 최신과 과거 dt 2개를  가져와.
1. 오늘까지 데이터 받기 : 오늘 날짜를 데이터를 받기 위해서 request dt로 설정해 데이터 수신. 연속조회 실행. 수신된 나 정목의 최신날짜 code로 넘어가기 전에 tb_stock_investor_chart.dt가 2000-01-02보다 더 최근의 날짜라면 
더 받아올 데이터가 있다는 뜻이므로 tb_stock_investor_chart.dt -1일을 request body의 dt로 세팅해서 다시 request를 보내서 데이터를 받아와.
이 과정을 tb_stock_investor_chart.dt가 2000-01-02보다 더 이전 날짜가 될때까지 반복해서 데이터를 받아와.
그 이후에 다음 code로 넘어가도록 해줘.
기존에 프로그램 구조를 변경해야 한다면 너의 의견을 제시해줘.



     이제 서버를 재시작하고 테스트하면 100건씩 수신할 때마다 "현재 종목 수신"과 "누적 수신" 
   카운터가 실시간으로 업데이트됩니다!

 > docker를 재기동해야 하나

 ● 네, Docker를 사용하고 계시다면 재빌드하고 재기동해야 합니다.

 ✔ Check Docker Compose files
    $ cd /Users/juhyunhwang/kiwoom && ls -la docker-compose*.yml
    └ 3 lines...

 ✔ Check running Docker containers
    $ cd /Users/juhyunhwang/kiwoom && docker ps --filter "name=kiwoom" --format "table 
    {{.Names}}\t{{.Status}}\t{{.Ports}}"
    └ 6 lines...

 ● 네, Docker 컨테이너들이 실행 중입니다. 변경사항을 적용하려면 재빌드하고 재시작해야 
   합니다:

 ✔ Check Docker Compose app service
    $ cd /Users/juhyunhwang/kiwoom && cat docker-compose.yml | grep -A 5 "app:"
    └ 7 lines...

 ● 다음 명령어들을 순서대로 실행하세요:

     cd /Users/juhyunhwang/kiwoom
     
     # 1. 컨테이너 중지 및 제거
     docker-compose down
     
     # 2. 이미지 재빌드 (변경사항 반영)
     docker-compose build --no-cache
     
     # 3. 컨테이너 재시작
     docker-compose up -d
     
     # 4. 로그 확인 (선택사항)
     docker-compose logs -f app

   또는 한 번에:

 ✔ Display Docker restart commands
    $ cat << 'EOF'
    # Docker 재빌드 및 재시작 명령어:

    cd /Users/juhyunhwang/kiwoom...
    └ 30 lines...

 ● 요약:

     - 백엔드(Java): build/libs/*.jar 파일이 이미 빌드되었으므로 Docker 이미지 재빌드 필요
     - 프론트엔드(React): frontend/dist/ 폴더가 이미 빌드되었으므로 Docker 이미지 재빌드 
   필요

   빠른 재시작 (권장):

     cd /Users/juhyunhwang/kiwoom
     docker-compose down && docker-compose build && docker-compose up -d

   재시작 후:

     - http://localhost:3
     - KOSPI200 배치 수집 시작
     - **"현재 종목 수신"**과 "누적 수신" 카운터가 100건씩 실시간 업데이트되는 것을 확인!

 ~/kiwoom/src/main/java/com/stocktrading/kiw[⎇ feature/data-co...*]claude-sonnet-4.5 (1x)
 om
 ──────