# ka10060 종목별투자자기관별차트요청 - 아키텍처 문서

## 1. 개요

**ka10060**은 키움 OpenAPI를 통해 종목별 투자자(개인/외국인/기관) 매매 데이터를 수집하는 TR(Transaction)입니다.

### 관련 테이블
| 테이블명 | 용도 |
|---------|------|
| `tb_stock_list` | 전체 종목 리스트 (시장별) |
| `tb_stock_list_meta` | KOSPI200 종목 메타 정보 |
| `tb_stock_investor_chart` | 종목별 투자자 매매 데이터 저장 |

---

## 2. 시스템 아키텍처 (Hexagonal Architecture)

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                    Frontend (React)                                  │
│                                   DataCollection.tsx                                 │
└─────────────────────────────────────────────┬───────────────────────────────────────┘
                                              │ HTTP Request
                                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              Controller Layer (Adapter In)                           │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                        InvestorChartController.java                            │  │
│  │  - POST /api/v1/investor-chart/fetch          (단일 수집)                       │  │
│  │  - POST /api/v1/investor-chart/kospi200/batch (KOSPI200 배치 수집)              │  │
│  │  - GET  /api/v1/investor-chart/{stockCode}    (DB 조회)                         │  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────┬───────────────────────────────────────┘
                                              │ UseCase Interface
                                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                Domain Layer (Core)                                   │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                           Port (In) - UseCase                                │    │
│  │  ┌─────────────────────────────┐  ┌─────────────────────────────┐           │    │
│  │  │ FetchInvestorChartUseCase   │  │ QueryInvestorChartUseCase   │           │    │
│  │  │ - fetchByStock()            │  │ - queryByStockAndDate()     │           │    │
│  │  │ - fetchRecent()             │  │ - queryByStockAndPeriod()   │           │    │
│  │  │ - fetchAllWithContinuation()│  │ - queryLatestByStock()      │           │    │
│  │  └─────────────────────────────┘  └─────────────────────────────┘           │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                              Domain Model                                    │    │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │    │
│  │  │                        InvestorChart.java                            │    │    │
│  │  │  - stockCode, date, unitType                                         │    │    │
│  │  │  - currentPrice, previousDayDifference                               │    │    │
│  │  │  - InvestorData (individual, foreigner, institution)                 │    │    │
│  │  │  - InstitutionBreakdown (금융투자, 보험, 투신, 은행, 연기금 등)         │    │    │
│  │  └─────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                          Port (Out) - Repository                             │    │
│  │  ┌─────────────────────────┐  ┌─────────────────────────┐                   │    │
│  │  │   InvestorChartPort     │  │     StockListPort       │                   │    │
│  │  │  - save(), saveAll()    │  │  - findAllKospi200Stocks│                   │    │
│  │  │  - findByStockAndDate() │  │  - findByCode()         │                   │    │
│  │  │  - findDateRangeByStock │  │                         │                   │    │
│  │  └─────────────────────────┘  └─────────────────────────┘                   │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                              TR (Transaction)                                │    │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │    │
│  │  │                        InvestorChartTR.java                          │    │    │
│  │  │  - getTrId(): "ka10060"                                              │    │    │
│  │  │  - buildRequestBody(): dt, stk_cd, amt_qty_tp, trde_tp, unit_tp      │    │    │
│  │  │  - parseResponse(): JSON → ChartData List                            │    │    │
│  │  └─────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────┬───────────────────────────────────────┘
                                              │
                                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           Application Service Layer                                  │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                   InvestorChartApplicationService.java                         │  │
│  │  implements FetchInvestorChartUseCase, QueryInvestorChartUseCase               │  │
│  │                                                                                 │  │
│  │  핵심 메서드:                                                                    │  │
│  │  - fetchByStock()              : 단일 종목 데이터 수집                           │  │
│  │  - fetchKospi200Batch()        : KOSPI200 전체 배치 수집 (★핵심)                 │  │
│  │  - fetchStockWithPreloadedRange(): 종목별 양방향 수집 (최신+과거)                 │  │
│  │  - fetchSingleDateWithContinuationFlux(): 연속조회 처리 (100건씩)                │  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────┬───────────────────────────────────────┘
                                              │
                                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              Adapter Layer (Out)                                     │
│  ┌────────────────────────────────┐  ┌────────────────────────────────────────────┐ │
│  │ InvestorChartPersistenceAdapter│  │         KiwoomApiAdapter                    │ │
│  │ - save() → Upsert              │  │  - POST https://api.kiwoom.com/api/dostk/   │ │
│  │ - saveAll()                    │  │        chart                                │ │
│  │ - findByStockAndDate()         │  │  - Header: cont-yn, next-key (연속조회)     │ │
│  │ - findDateRangeByStock()       │  │                                            │ │
│  └────────────────────────────────┘  └────────────────────────────────────────────┘ │
│              │                                       │                               │
│              ▼                                       ▼                               │
│  ┌────────────────────────────────┐  ┌────────────────────────────────────────────┐ │
│  │   StockInvestorChartRepository │  │          Kiwoom OpenAPI Server             │ │
│  │   (JPA)                        │  │      https://api.kiwoom.com                │ │
│  └────────────────────────────────┘  └────────────────────────────────────────────┘ │
│              │                                                                       │
│              ▼                                                                       │
│  ┌────────────────────────────────┐                                                 │
│  │       PostgreSQL DB            │                                                 │
│  │  tb_stock_investor_chart       │                                                 │
│  └────────────────────────────────┘                                                 │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 클래스별 역할 및 호출 관계

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              호출 흐름 (Call Flow)                                   │
└─────────────────────────────────────────────────────────────────────────────────────┘

[Frontend]
    │
    │ POST /api/v1/investor-chart/kospi200/batch
    ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│ InvestorChartController                                                             │
│   │                                                                                 │
│   │ fetchUseCase.fetchKospi200Batch()                                              │
│   ▼                                                                                 │
├─────────────────────────────────────────────────────────────────────────────────────┤
│ InvestorChartApplicationService                                                     │
│   │                                                                                 │
│   ├─→ stockListPort.findAllKospi200Stocks()  ←── tb_stock_list_meta 조회           │
│   │         │                                                                       │
│   │         ▼                                                                       │
│   │   StockListPersistenceAdapter                                                   │
│   │         │                                                                       │
│   │         ▼                                                                       │
│   │   StockListMetaRepository (JPA)                                                │
│   │                                                                                 │
│   ├─→ chartPort.findDateRangesByStocks()  ←── 날짜범위 일괄 조회 (최적화)            │
│   │         │                                                                       │
│   │         ▼                                                                       │
│   │   InvestorChartPersistenceAdapter                                              │
│   │         │                                                                       │
│   │         ▼                                                                       │
│   │   StockInvestorChartRepository (JPA)                                           │
│   │                                                                                 │
│   ├─→ fetchStockWithPreloadedRange()  ←── 종목별 수집 로직                          │
│   │         │                                                                       │
│   │         ├─→ fetchRecentDataFlux()   (오늘 → maxStockDate)                       │
│   │         │                                                                       │
│   │         └─→ fetchPastDataFlux()     (minStockDate-1 → 2000-01-02)              │
│   │                   │                                                             │
│   │                   ▼                                                             │
│   │         fetchSingleDateWithContinuationFlux()  ←── 연속조회 핵심                │
│   │                   │                                                             │
│   │                   ├─→ callInvestorChartApiWithHeaders()                        │
│   │                   │         │                                                   │
│   │                   │         ▼                                                   │
│   │                   │   KiwoomApiPort.postWithHeaders()                           │
│   │                   │         │                                                   │
│   │                   │         ▼                                                   │
│   │                   │   ┌─────────────────────────────┐                          │
│   │                   │   │  Kiwoom API Server          │                          │
│   │                   │   │  POST /api/dostk/chart      │                          │
│   │                   │   │  (ka10060)                  │                          │
│   │                   │   └─────────────────────────────┘                          │
│   │                   │         │                                                   │
│   │                   │         ▼ JSON Response                                    │
│   │                   │                                                             │
│   │                   ├─→ InvestorChartTR.parseResponse()                          │
│   │                   │                                                             │
│   │                   ├─→ parseResponseWithStopCondition()                         │
│   │                   │         │                                                   │
│   │                   │         ▼ 중단조건 체크 (stopDate 이하 데이터)               │
│   │                   │                                                             │
│   │                   └─→ chartPort.saveAll()  ←── DB 저장                          │
│   │                             │                                                   │
│   │                             ▼                                                   │
│   │                   ┌─────────────────────────────┐                              │
│   │                   │  PostgreSQL                 │                              │
│   │                   │  tb_stock_investor_chart    │                              │
│   │                   └─────────────────────────────┘                              │
│   │                                                                                 │
│   └─→ SSE(Server-Sent Events)로 진행상황 실시간 전송                                 │
│               │                                                                     │
│               ▼                                                                     │
│         Kospi200BatchProgress (DTO)                                                │
│         - currentStockCode, currentStockName                                       │
│         - processedCount / totalCount                                              │
│         - receivedCount, savedCount                                                │
│         - cumulativeReceivedCount, cumulativeSavedCount                            │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 핵심 알고리즘: KOSPI200 배치 수집

### 4.1 전체 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                    fetchKospi200Batch() 알고리즘                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘

   ┌──────────────────────────────────────────┐
   │  1. KOSPI200 종목 목록 조회               │
   │     tb_stock_list_meta 테이블에서         │
   │     (약 200개 종목)                       │
   └──────────────────┬───────────────────────┘
                      ▼
   ┌──────────────────────────────────────────┐
   │  2. 모든 종목 날짜범위 일괄 조회          │
   │     (최적화: DB 1회 호출)                 │
   │     GROUP BY stock_code                  │
   │     SELECT MIN(dt), MAX(dt)              │
   └──────────────────┬───────────────────────┘
                      ▼
   ┌──────────────────────────────────────────┐
   │  3. 종목 분류                             │
   │     ├─ stocksToSkip: 이미 완전 수집됨     │
   │     │   (2000-01-02 ~ 오늘 모두 있음)     │
   │     └─ stocksToProcess: 수집 필요         │
   └──────────────────┬───────────────────────┘
                      ▼
   ┌──────────────────────────────────────────┐
   │  4. 스킵 종목 진행상황 emit               │
   │     (수집 불필요 종목 빠르게 처리)         │
   └──────────────────┬───────────────────────┘
                      ▼
   ┌──────────────────────────────────────────┐
   │  5. 수집 필요 종목 순차 처리              │
   │     Flux.fromIterable().concatMap()      │
   │     (종목 간 sleep 없음)                  │
   └──────────────────┬───────────────────────┘
                      ▼
              ┌───────┴───────┐
              ▼               ▼
   ┌──────────────────┐ ┌──────────────────┐
   │ 최신 데이터 수집  │ │ 과거 데이터 수집  │
   │ (오늘→maxStockDate)│ │ (minStockDate-1  │
   │                  │ │  →2000-01-02)    │
   └────────┬─────────┘ └────────┬─────────┘
            │                    │
            └────────┬───────────┘
                     ▼
   ┌──────────────────────────────────────────┐
   │  6. SSE로 진행상황 실시간 전송            │
   │     - 현재 종목/진행률                    │
   │     - 수신/저장 건수                      │
   │     - 누적 통계                          │
   └──────────────────────────────────────────┘
```

### 4.2 연속조회 알고리즘 (fetchSingleDateWithContinuationFlux)

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          연속조회 알고리즘 (Recursive)                               │
└─────────────────────────────────────────────────────────────────────────────────────┘

   ┌─────────────────────────────────────────┐
   │  API 호출                                │
   │  POST /api/dostk/chart                   │
   │  Headers:                                │
   │    - cont-yn: "N" (최초) / "Y" (연속)    │
   │    - next-key: "" (최초) / "값" (연속)   │
   └───────────────────┬─────────────────────┘
                       ▼
   ┌─────────────────────────────────────────┐
   │  응답 수신 (최대 100건/요청)             │
   │  Response Headers:                       │
   │    - cont-yn: "Y" (다음 있음) / "N"     │
   │    - next-key: "다음키"                 │
   └───────────────────┬─────────────────────┘
                       ▼
   ┌─────────────────────────────────────────┐
   │  중단 조건 체크                          │
   │  if (수신 데이터 날짜 <= stopDate) {     │
   │      stopReached = true;                │
   │      해당 데이터 저장 제외               │
   │  }                                      │
   └───────────────────┬─────────────────────┘
                       ▼
   ┌─────────────────────────────────────────┐
   │  유효 데이터 DB 저장                     │
   │  chartPort.saveAll(filteredCharts)      │
   └───────────────────┬─────────────────────┘
                       ▼
        ┌──────────────┴──────────────┐
        │                             │
        ▼                             ▼
   ┌──────────┐               ┌──────────────┐
   │ 중단도달  │               │ cont-yn="Y"  │
   │ OR       │               │ AND          │
   │ cont-yn  │               │ !stopReached │
   │ ="N"     │               └──────┬───────┘
   └────┬─────┘                      │
        │                            ▼
        │                   ┌──────────────────┐
        │                   │  2.5초 대기       │
        │                   │  Mono.delay(2500)│
        │                   └────────┬─────────┘
        │                            │
        │                            ▼
        │                   ┌──────────────────┐
        │                   │  재귀 호출        │
        │                   │  cont-yn="Y"     │
        │                   │  next-key=응답값  │
        │                   └────────┬─────────┘
        │                            │
        ▼                            │
   ┌──────────┐                      │
   │  완료    │◄─────────────────────┘
   │  return  │
   │  총건수   │
   └──────────┘
```

---

## 5. 양방향 수집 알고리즘

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            양방향 수집 전략                                          │
│                   fetchStockWithPreloadedRange()                                    │
└─────────────────────────────────────────────────────────────────────────────────────┘

  DB 상태 예시:
  ┌──────────────────────────────────────────────────────────────────────────────────┐
  │                                                                                  │
  │  2000-01-02              minStockDate           maxStockDate              오늘    │
  │      │                       │                     │                      │      │
  │      ▼                       ▼                     ▼                      ▼      │
  │  ────┼───────────────────────┼─────────────────────┼──────────────────────┼────  │
  │      │                       │▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓│                      │      │
  │      │    과거 수집 필요      │   기존 DB 데이터     │    최신 수집 필요     │      │
  │      │◄──────────────────────│                     │─────────────────────►│      │
  │                                                                                  │
  │  수집 방향:                                                                       │
  │  1. 최신 수집: 오늘 → maxStockDate까지 (maxStockDate 이하 중단)                    │
  │  2. 과거 수집: minStockDate-1 → 2000-01-02까지 (2000-01-02 이하 중단)              │
  │                                                                                  │
  └──────────────────────────────────────────────────────────────────────────────────┘

  수집 필요 여부 판단:
  ┌────────────────────────────────────────────────────────────────────────┐
  │ Case 1: DB에 데이터 없음                                               │
  │   → needRecentData = true                                             │
  │   → needPastData = true                                               │
  │   → 전체 수집 (오늘 → 2000-01-02)                                      │
  ├────────────────────────────────────────────────────────────────────────┤
  │ Case 2: 최신만 필요 (오늘 > maxStockDate)                               │
  │   → needRecentData = true                                             │
  │   → needPastData = false (2000-01-02 >= minStockDate)                 │
  ├────────────────────────────────────────────────────────────────────────┤
  │ Case 3: 과거만 필요 (2000-01-02 < minStockDate)                         │
  │   → needRecentData = false (오늘 == maxStockDate)                     │
  │   → needPastData = true                                               │
  ├────────────────────────────────────────────────────────────────────────┤
  │ Case 4: 양쪽 모두 필요                                                  │
  │   → needRecentData = true                                             │
  │   → needPastData = true                                               │
  ├────────────────────────────────────────────────────────────────────────┤
  │ Case 5: 완전 수집됨 (SKIP)                                             │
  │   → needRecentData = false                                            │
  │   → needPastData = false                                              │
  │   → 해당 종목 건너뜀                                                   │
  └────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 데이터 모델

### 6.1 tb_stock_investor_chart 테이블 구조

```sql
CREATE TABLE tb_stock_investor_chart (
    -- Primary Keys
    stk_cd          VARCHAR(20)   NOT NULL,  -- 종목코드
    dt              DATE          NOT NULL,  -- 일자
    
    -- Request Metadata
    unit_tp         VARCHAR(4)    NOT NULL,  -- 단위구분 (1:단주, 1000:천주)
    
    -- Market Data (시세 정보)
    cur_prc         BIGINT,                  -- 현재가
    pred_pre        BIGINT,                  -- 전일대비
    acc_trde_prica  BIGINT,                  -- 누적거래대금
    
    -- 주요 투자자별 데이터
    ind_invsr       BIGINT DEFAULT 0,        -- 개인투자자
    frgnr_invsr     BIGINT DEFAULT 0,        -- 외국인투자자
    orgn            BIGINT DEFAULT 0,        -- 기관계
    
    -- 기관 세부 내역
    fnnc_invt       BIGINT DEFAULT 0,        -- 금융투자
    insrnc          BIGINT DEFAULT 0,        -- 보험
    invtrt          BIGINT DEFAULT 0,        -- 투신
    etc_fnnc        BIGINT DEFAULT 0,        -- 기타금융
    bank            BIGINT DEFAULT 0,        -- 은행
    penfnd_etc      BIGINT DEFAULT 0,        -- 연기금등
    samo_fund       BIGINT DEFAULT 0,        -- 사모펀드
    natn            BIGINT DEFAULT 0,        -- 국가
    etc_corp        BIGINT DEFAULT 0,        -- 기타법인
    natfor          BIGINT DEFAULT 0,        -- 내외국인
    
    -- Audit
    created_at      TIMESTAMP,
    updated_at      TIMESTAMP,
    
    PRIMARY KEY (stk_cd, dt)
);

-- Indexes
CREATE INDEX idx_chart_stk_dt ON tb_stock_investor_chart (stk_cd, dt);
CREATE INDEX idx_chart_dt ON tb_stock_investor_chart (dt);
CREATE INDEX idx_chart_frgnr_orgn ON tb_stock_investor_chart (dt, frgnr_invsr, orgn);
```

### 6.2 InvestorChart 도메인 모델

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              InvestorChart (Domain Model)                            │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  ┌─────────────────────┐                                                            │
│  │    기본 정보         │                                                            │
│  │  - stockCode        │                                                            │
│  │  - date             │                                                            │
│  │  - unitType         │                                                            │
│  │  - currentPrice     │                                                            │
│  │  - previousDayDiff  │                                                            │
│  │  - accTradeAmount   │                                                            │
│  └─────────────────────┘                                                            │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                            InvestorData (Value Object)                       │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐     │    │
│  │  │ individual  │  │  foreigner  │  │ institution │  │ nationalForeign │     │    │
│  │  │   (개인)    │  │  (외국인)    │  │   (기관계)  │  │   (내외국인)    │     │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────┘     │    │
│  │                                                                               │    │
│  │  Methods:                                                                     │    │
│  │  - isForeignerNetBuy(): boolean  // 외국인 순매수 여부                         │    │
│  │  - isInstitutionNetBuy(): boolean // 기관 순매수 여부                          │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                      InstitutionBreakdown (Value Object)                     │    │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐                 │    │
│  │  │ financialInvest│  │   insurance    │  │   investment   │                 │    │
│  │  │    (금융투자)   │  │    (보험)      │  │    (투신)      │                 │    │
│  │  └────────────────┘  └────────────────┘  └────────────────┘                 │    │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐                 │    │
│  │  │  etcFinancial  │  │     bank       │  │   pensionFund  │                 │    │
│  │  │   (기타금융)    │  │    (은행)      │  │   (연기금등)   │                 │    │
│  │  └────────────────┘  └────────────────┘  └────────────────┘                 │    │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐                 │    │
│  │  │  privateFund   │  │     nation     │  │ etcCorporation │                 │    │
│  │  │   (사모펀드)    │  │    (국가)      │  │  (기타법인)    │                 │    │
│  │  └────────────────┘  └────────────────┘  └────────────────┘                 │    │
│  │                                                                               │    │
│  │  Methods:                                                                     │    │
│  │  - getByType(InstitutionType): Long  // 기관 유형별 조회                       │    │
│  │  - getTopBuyer(): InstitutionType    // 최대 순매수 기관                       │    │
│  │  - getTopSeller(): InstitutionType   // 최대 순매도 기관                       │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. API 요청/응답 구조

### 7.1 Kiwoom API 요청 (ka10060)

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  POST https://api.kiwoom.com/api/dostk/chart                                        │
├─────────────────────────────────────────────────────────────────────────────────────┤
│  Headers:                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │  Authorization: Bearer {access_token}                                        │   │
│  │  Content-Type: application/json                                              │   │
│  │  api-id: ka10060                                                             │   │
│  │  cont-yn: "N" (최초) / "Y" (연속조회)                                         │   │
│  │  next-key: "" (최초) / "{이전응답값}" (연속조회)                               │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  Body:                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │  {                                                                           │   │
│  │    "dt": "20241207",        // 조회 기준일자 (YYYYMMDD)                       │   │
│  │    "stk_cd": "005930",      // 종목코드                                       │   │
│  │    "amt_qty_tp": "2",       // 금액수량구분 (1:금액, 2:수량)                   │   │
│  │    "trde_tp": "0",          // 매매구분 (0:순매수, 1:매수, 2:매도)            │   │
│  │    "unit_tp": "1"           // 단위구분 (1:단주, 1000:천주)                   │   │
│  │  }                                                                           │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 Kiwoom API 응답

```json
{
  "return_code": 0,
  "return_msg": "success",
  "stk_invsr_orgn_chart": [
    {
      "dt": "20241206",
      "cur_prc": "+61300",
      "pred_pre": "-200",
      "acc_trde_prica": "1234567890",
      "ind_invsr": "-123456",
      "frgnr_invsr": "+234567",
      "orgn": "-111111",
      "fnnc_invt": "-50000",
      "insrnc": "+10000",
      "invtrt": "-30000",
      "etc_fnnc": "+5000",
      "bank": "-1000",
      "penfnd_etc": "+20000",
      "samo_fund": "-15000",
      "natn": "+1000",
      "etc_corp": "-50000",
      "natfor": "+0"
    },
    // ... 최대 100건
  ]
}

// Response Headers:
// cont-yn: "Y" (다음 데이터 있음) / "N" (없음)
// next-key: "다음조회키"
```

---

## 8. Sleep/대기 정책

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              Sleep 정책 (Rate Limiting 대응)                         │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │  1. 연속조회 간 대기 (서버 Request 시)                                        │   │
│  │     - 위치: fetchSingleDateWithContinuationFlux()                            │   │
│  │     - 대기시간: 2.5초 (Duration.ofMillis(2500))                              │   │
│  │     - 목적: 키움 API Rate Limit 준수                                         │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │  2. 최신→과거 전환 시 대기                                                    │   │
│  │     - 위치: fetchStockWithPreloadedRange()                                   │   │
│  │     - 대기시간: 2.5초                                                        │   │
│  │     - 목적: 방향 전환 시 API 과부하 방지                                       │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │  3. 종목 간 이동 시                                                          │   │
│  │     - 대기시간: 없음 (0초)                                                   │   │
│  │     - 이유: 서버 Request가 아닌 단순 종목 변경이므로                          │   │
│  │            Rate Limit에 영향 없음                                            │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. 주요 클래스 요약

| 클래스 | 위치 | 역할 |
|--------|------|------|
| `InvestorChartController` | controller/ | REST API 엔드포인트 |
| `InvestorChartApplicationService` | application/service/ | 비즈니스 로직 (UseCase 구현) |
| `FetchInvestorChartUseCase` | domain/port/in/ | 수집 UseCase 인터페이스 |
| `QueryInvestorChartUseCase` | domain/port/in/ | 조회 UseCase 인터페이스 |
| `InvestorChartPort` | domain/port/out/ | 저장소 포트 인터페이스 |
| `StockListPort` | domain/port/out/ | 종목리스트 포트 인터페이스 |
| `InvestorChart` | domain/model/ | 도메인 모델 |
| `InvestorChartTR` | domain/tr/ | TR 요청/응답 처리 |
| `InvestorChartPersistenceAdapter` | adapter/out/persistence/ | JPA 저장소 구현 |
| `StockInvestorChart` | adapter/out/persistence/entity/ | JPA Entity |
| `StockInvestorChartRepository` | adapter/out/persistence/repository/ | JPA Repository |

---

## 10. 성능 최적화 포인트

1. **날짜 범위 일괄 조회**: 모든 종목의 min/max 날짜를 한 번의 DB 쿼리로 조회
2. **스킵 처리**: 이미 완전 수집된 종목은 바로 건너뜀
3. **종목 간 대기 제거**: 서버 Request 시에만 대기, 종목 전환 시 대기 없음
4. **Upsert 전략**: 기존 데이터가 있으면 업데이트, 없으면 삽입
5. **배치 저장**: saveAll()로 다건 저장하여 DB 커넥션 효율화
