# PRD: 통계분석 - 투자자 수급분석 (Investor Supply/Demand Analysis)

## 1. 개요 (Overview)
본 문서는 KOSPI200 전 종목을 대상으로 투자자별(개인, 외국인, 기관 등) 수급 현황을 분석하기 위해 누적 투자금액 및 누적 순매수량을 계산하고, 이를 시각화하여 제공하는 시스템의 요구사항을 정의합니다. 이를 통해 주가 변동과 특정 투자 주체의 수급 간 상관관계를 파악할 수 있는 데이터를 제공합니다.

## 2. 목표 (Goals)
1.  **데이터 마트 구축**: 2000년 1월 2일부터 현재까지의 모든 KOSPI200 종목에 대해 투자자별 누적 투자금액 및 누적 순매수량 데이터를 생성 및 저장.
2.  **자동화**: 일별 신규 데이터 발생 시 자동으로 누적 데이터를 갱신하는 배치(Batch) 프로세스 구현.
3.  **시각화 및 분석**: 웹 프론트엔드를 통해 투자자별 누적 금액, 일별 순매수량/금액 차트를 조회하고, 특정 기간의 평균 매수 단가를 분석할 수 있는 기능 제공.

## 3. 데이터 요구사항 (Database Requirements)

### 3.1 대상 데이터
*   **기간**: 2000-01-02 ~ 현재
*   **종목**: KOSPI200 전체 종목
*   **투자자 구분**:
    *   기존: 개인, 외국인, 기관계, 금융투자, 보험, 투신, 기타금융, 은행, 연기금등, 사모펀드, 국가, 기타법인, 내외국인
    *   **신규 추가**: 외국인+기관 (frgnr_invsr + orgn)

### 3.2 테이블 설계 (Schema)
*   **테이블명**: `tb_stock_investor_invest_accumulation`
*   **Primary Key**: `stk_cd` (종목코드), `dt` (일자)
*   **주요 컬럼**:
    *   기본 정보: `stk_cd`, `dt`, `sector`, `category1~3`
    *   **일별 순매수량 (Daily Net Buy Qty)**: `tb_stock_investor_chart`의 값을 그대로 이관 (예: `ind_invsr`, `frgnr_invsr` 등).
    *   **누적 순매수량 (Cumulative Net Buy Qty)**: *[신규 계산]* 전일 누적 + 당일 순매수량 (예: `ind_invsr_net_buy_qty`).
    *   **누적 투자금액 (Cumulative Net Buy Amount)**: *[신규 계산]* 전일 누적 + (당일 `cur_prc` × 당일 순매수량). (소수점 이하 절사하여 저장). (예: `ind_invsr_net_buy_amount`).

### 3.3 데이터 처리 로직 (Logic)
*   **초기 적재 (Migration)**:
    *   `tb_stock_investor_chart`의 2000-01-02 이후 데이터를 시간순으로 정렬.
    *   최초 데이터의 누적 금액/수량은 0에서 시작하여 순차적으로 누적.
*   **일일 갱신 (Daily Update)**:
    *   **On-Demand 업데이트**: 수급분석 화면에서 특정 종목을 조회할 때, 원천 테이블(`tb_stock_investor_chart`)과 누적 테이블(`tb_stock_investor_invest_accumulation`)의 최신 일자(`max(dt)`)를 비교합니다. 원천 테이블에 새로운 데이터가 존재할 경우, 해당 차이분(Gap)에 대해 전일 누적 데이터에 가산하여 자동으로 Insert 합니다.
    *   `frgnr_invsr_orgn(외국인+기관)`은 `frgnr_invsr`와 `orgn`의 합으로 별도 계산.

### 3.4 데이터베이스 운영 전략 (Opinionated Recommendation)
*   **예상 데이터 용량**: 종목당 약 6,000건 × 200종목 = 약 120만 건.
*   **파티셔닝 (Partitioning)**: 120만 건은 최신 RDBMS(PostgreSQL/MySQL)에서 단일 테이블로 처리하기에 부담 없는 크기이므로, 초기에는 **파티셔닝 없이** 구성하는 것을 권장합니다. 관리 복잡도를 줄이는 것이 우선입니다.
    *   향후 데이터가 수천만 건으로 늘어날 경우, `dt` 컬럼 기준의 **Range Partitioning (연도별)** 도입을 고려할 수 있습니다.
*   **인덱싱 (Indexing)**:
    *   **PK**: `(stk_cd, dt)` - 복합키 인덱스로 종목별 시계열 조회 최적화.
    *   조회 성능 향상을 위해 조회 조건에 자주 사용되는 컬럼이 있다면 추가 인덱스 고려 (현재 요구사항에서는 PK 만으로 충분).

## 4. 백엔드 기능 요구사항 (Backend Functional Requirements)

### 4.1 누적 계산 배치 프로그램
*   **기능**: 전체 KOSPI200 종목의 전체 과거 데이터를 대상으로 초기 적재(Initial Load)를 수행하는 로직과(초기 딱 한버만 수행), 조회 시점의 델타(Delta) 업데이트 로직 구현.
*   **입력**: `tb_stock_investor_chart`
*   **출력**: `tb_stock_investor_invest_accumulation`

### 4.2 분석 API 구현
*   **API 명**: 기간별 투자자 분석 조회
*   **입력 파라미터**: 종목코드(`stk_cd`), 시작일(`start_dt`), 종료일(`end_dt`)
*   **출력 데이터**:
    *   해당 기간의 일별 데이터 리스트.
    *   **평균 매수단가 계산 로직**: `(종료일 누적금액 - 시작일 전일 누적금액) / (종료일 누적수량 - 시작일 전일 누적수량)` (단, 분모가 0일 경우 예외처리). *[요구사양의 "변화량" 기반 해석]*

## 5. 프론트엔드 기능 요구사항 (Frontend Functional Requirements)

### 5.1 메뉴 및 네비게이션
*   **메인 대시보드**: "차트 분석" 버튼을 "주식종목 리스트"와 같이 별도의 박스(Block) 형태로 구성하여 배치.
*   **차트 페이지 URL**: `/moving-chart` (기존 `/moving-average-chart`에서 변경).
*   **통합 차트 페이지**: `/moving-chart` 페이지 내에 기존의 **"투자자 이동평균 차트"**와 신규 **"투자자 수급분석 차트"**를 모두 포함하여 탭이나 버튼으로 선택하여 볼 수 있도록 구성.
*   **기능 복구**: **"투자자 이동평균 차트"**와 **"투자자 수급분석 차트"** 화면 모두에 "과거데이터 +4년" 버튼을 복구하고, 클릭 시 과거 데이터를 추가로 로드하는 기능을 연결합니다.

### 5.2 차트 구성 상세
#### A. 공통 사항
*   **데이터 표기 단위**: 화면에 표시되는 모든 금액 데이터(누적금액, 순매수금액 등)는 **1억 원 단위**로 환산하여 표시 (예: 123.45억 원).

#### B. 투자자 이동평균 분석 차트 (Moving Average Chart)
*   **제거**: 5, 10, 20, 60일 이동평균 선택 콤보박스 제거.
*   **기능 유지**: 기존의 투자자 토글, 줌/팬 기능, 초기 span 설정 등은 그대로 유지.

#### C. 투자자 수급분석 차트 (Investor Supply/Demand Chart)
*   **변경 전**: 누적금액, 일별수량, 일별금액 3개 차트 분리 표시.
*   **변경 후 (최종)**: **단일 차트(Dual Axis)** 형식으로 통합.
    *   **구성**:
        *   **좌측 Y축**: 투자자별 **누적 순매수량** (Cumulative Net Buy Qty).
        *   **우측 Y축**: 투자자별 **누적 순매수 금액** (Cumulative Net Buy Amount).
        *   **보조/Overlay**: 현재가(Current Price) 표시.
    *   **컨트롤**:
        *   **제거**: 차트 종류 선택 버튼 3개 제거.
        *   **추가**: "현재가", "외국인", "기관" 등 투자자별 표시 여부를 선택할 수 있는 **토글 버튼** 추가 (이동평균 차트와 유사한 UX).
    *   **UX**: 초기 그래프 표현 방식, 줌/팬, View Span 기능은 "투자자 이동평균 분석"과 동일하게 적용.

### 5.3 화면 변경 요구사항

1. **변경대상 화면**: "투자자 이동평균 분석"
   - **변경내용**: "과거데이터 +4년" 버튼을 복구하고 클릭 시 과거 데이터를 추가로 로드하는 기존 기능을 연결.

2. **변경대상 화면**: "투자자수급분석"
   - **변경내용**:
     1. "투자자 이동평균 분석" 화면과 같이 "현재가 외국인, 기관 등 투자자 토글버튼" 추가.
     2. "과거데이터 +4년" 버튼을 추가하고(투자자상관분석 화면과 같은 스타일, 위치), 클릭 시 화면에 표시되는 데이터(누적순매수량, 누적순매수금액)의 과거 데이터를 추가로 로드하는 기존 기능을 연결.
     3. 현재가와 누적순매수는 왼쪽 Y축 기준으로, 투자자별 누적순매수 금액은 우측 Y축 기준으로 표시.
     4. 투자자별 데이터를 보여주며, 초기 그래프 표현 방식(초기 표현 개월수 span 등)은 "투자자 이동평균 분석" 화면과 동일하게 구현.

3. **변경대상 화면**: 투자자 상관분석
    - **변경내용**: "과거 데이터 +4년" 버튼을 "투자자 이동평균 분석" 내에 있는 "과거 데이터 +4년 이동평균" 버튼과 같은 위치, 스타일로 변경.

## 6. 개발 및 테스트 계획
1.  **DB 스키마 생성**: `tb_stock_investor_invest_accumulation` 테이블 생성.
2.  **백엔드 로직 구현**: 초기 적재 로직 구현 및 데이터 검증.
3.  **API 개발**: 조회 및 평균단가 계산 API 개발.
4.  **프론트엔드 UI 수정**: 라우팅 변경, 버튼 추가, 차트 컴포넌트 구현.
5.  **통합 테스트**: 데이터 정합성 확인 (누적값이 올바르게 계산되었는지 샘플 종목 검증).
